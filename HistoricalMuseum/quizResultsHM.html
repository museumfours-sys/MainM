<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>Historical Museum ‚Äî Results</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<style>
  html,body{height:100%}
  body{margin:0;display:flex;align-items:center;justify-content:center;font-family:Segoe UI, Tahoma, Geneva, Verdana, sans-serif;background:linear-gradient(135deg,#fff7ec 0%,#efe6d6 100%);padding-top:env(safe-area-inset-top);padding-bottom:env(safe-area-inset-bottom)}
  .box{background:#fff;padding:1.8rem;border-radius:14px;max-width:620px;width:100%;box-shadow:0 10px 28px rgba(0,0,0,.10);position:relative}
  .lang{position:absolute;top:12px;right:12px;display:flex;gap:.4rem}
  .lang button{background:#fff3e0;border:2px solid #e0a169;padding:.3rem .6rem;border-radius:8px;cursor:pointer}
  .lang button.active{background:#ffcc80}
  h2{color:#6b3f00;margin:0 0 .6rem 0;text-align:center}
  .score{font-size:2rem;color:#4b2e13;text-align:center;margin:.6rem 0}
  .msg{color:#6b3f00;text-align:center;margin:.6rem 0}
  .details{margin-top:1rem;background:#fff7f0;padding:1rem;border-radius:8px;max-height:260px;overflow:auto}
  .mistake-line{margin:.3rem 0;color:#4b2e13}
  .mistake-line em.user{color:#d32f2f;font-weight:600;font-style:normal}
  .mistake-line em.correct{color:#38a169;font-weight:600;font-style:normal}
  .btn{display:block;margin:1rem auto 0 auto;padding:.6rem 1.2rem;border-radius:10px;border:none;background:linear-gradient(90deg,#c77,#e0a169);color:#fff;cursor:pointer;font-weight:600;min-height:44px;font-size:1rem;transition:all 0.2s ease}
  .btn:hover{transform:translateY(-2px);box-shadow:0 8px 16px rgba(199,119,119,0.2)}
  @media(max-width:620px){
    .box{padding:1.2rem 0.9rem;border-radius:12px;margin:0.5rem;max-width:95vw}
    h2{font-size:1.2rem;margin:0 0 0.5rem 0}
    .score{font-size:1.8rem;margin:0.5rem 0}
    .msg{font-size:0.95rem;margin:0.7rem 0}
    .details{padding:0.9rem;margin-top:0.7rem;max-height:280px;border-radius:8px;font-size:0.9rem}
    .btn{margin:0.8rem auto 0;padding:0.7rem 1.2rem;font-size:0.9rem}
    .lang{top:0.5rem;right:0.5rem}
    .lang button{padding:0.2rem 0.45rem;font-size:0.65rem;border-radius:6px;border-width:1px}
  }
</style>
</head>
<body>
  <div class="box">
    <div class="lang">
      <button id="btn-en" onclick="setLang('en')">EN</button>
      <button id="btn-bg" onclick="setLang('bg')">BG</button>
    </div>

    <h2 id="results-title">Quiz Results</h2>
    <div class="score" id="score"></div>
    <div class="msg" id="message"></div>

    <div class="details" id="details" style="display:none"></div>
  </div>

<script>
const translations = {
  en:{
    results:"Quiz Results",
    wellDone:"Perfect! You're a true historian! üéâ",
    messages:[
      { min:0, max:20, text:"Don't worry! üí™" },
      { min:20, max:40, text:"Good effort! üìö" },
      { min:40, max:60, text:"Nice work! üåü" },
      { min:60, max:80, text:"Very good! üöÄ" },
      { min:80, max:100, text:"Excellent! You really know your stuff! üëè" }
    ],
    back:"Back to start",
    mistakes:"Your mistakes:",
    yourAnswer:"Your answer:",
    correctAnswer:"Correct answer:"
  },
  bg:{
    results:"–†–µ–∑—É–ª—Ç–∞—Ç–∏ –æ—Ç –≤–∏–∫—Ç–æ—Ä–∏–Ω–∞—Ç–∞",
    wellDone:"–ü–µ—Ä—Ñ–µ–∫—Ç–Ω–æ! –í–∏–µ —Å—Ç–µ –∏—Å—Ç–∏–Ω—Å–∫–∏ –∏—Å—Ç–æ—Ä–∏–∫! üéâ",
    messages:[
      { min:0, max:20, text:"–ù–µ —Å–µ –ø—Ä–∏—Ç–µ—Å–Ω—è–≤–∞–π—Ç–µ, —á–æ–≤–µ–∫ –Ω–µ —Å–µ —É—á–∏ –∑–∞ –µ–¥–∏–Ω –¥–µ–Ω! üí™" },
      { min:20, max:40, text:"–î–æ–±—ä—Ä –æ–ø–∏—Ç! üìö" },
      { min:40, max:60, text:"–ü–æ—á—Ç–∏ —É—Å–ø—è—Ö—Ç–µ! üåü" },
      { min:60, max:80, text:"–ú–Ω–æ–≥–æ –¥–æ–±—ä—Ä —Ä–µ–∑—É–ª—Ç–∞—Ç! üöÄ" },
      { min:80, max:100, text:"–û—Ç–ª–∏—á–Ω–æ! –ù–∞–∏—Å—Ç–∏–Ω–∞ —Å—Ç–µ –Ω–∞—É—á–∏–ª–∏ –¥–æ—Å—Ç–∞! üëè" }
    ],
    back:"–ù–∞–∑–∞–¥ –∫—ä–º –Ω–∞—á–∞–ª–æ—Ç–æ",
    mistakes:"–í–∞—à–∏—Ç–µ –≥—Ä–µ—à–∫–∏:",
    yourAnswer:"–í–∞—à–∏—è—Ç –æ—Ç–≥–æ–≤–æ—Ä:",
    correctAnswer:"–ü—Ä–∞–≤–∏–ª–µ–Ω –æ—Ç–≥–æ–≤–æ—Ä:"
  }
};

let lang = localStorage.getItem('language') || 'en';
function setLang(l){ lang = l; localStorage.setItem('language', l); render(); }

function normalize(s){ return (s||"").toString().trim().toLowerCase(); }

function render(){
  document.getElementById('btn-en').classList.toggle('active', lang==='en');
  document.getElementById('btn-bg').classList.toggle('active', lang==='bg');
  document.getElementById('results-title').textContent = translations[lang].results;

  const correct = JSON.parse(localStorage.getItem('correctAnswersHM') || '[]');
  const user = JSON.parse(localStorage.getItem('userAnswersHM') || '[]');
  const questionsData = JSON.parse(localStorage.getItem('questionsHM') || '[]');
  let correctCount = 0;
  const mistakes = [];

  for(let i=0;i<correct.length;i++){
    const correctItem = correct[i] || [];
    const u = user[i] || "";
    const qObj = questionsData[i] || {};
    
    // Get the correct answers for current language
    let accepted = [];
    if (typeof correctItem === 'object' && !Array.isArray(correctItem)) {
      accepted = correctItem[lang] || correctItem.en || [];
    } else {
      accepted = correctItem;
    }
    
    // Get the question text from text.en/text.bg or question/questionBg
    let questionText = '';
    if (qObj.text && typeof qObj.text === 'object') {
      questionText = lang === 'en' ? (qObj.text.en || '') : (qObj.text.bg || '');
    } else {
      questionText = lang === 'en' ? (qObj.question || '') : (qObj.questionBg || '');
    }
    
    const ok = accepted.some(a => normalize(a) === normalize(u));
    if(ok) {
      correctCount++;
    } else {
      // Filter correct answers to show only current language
      let langAnswer = Array.isArray(accepted) ? (lang === 'en' ? [accepted[0]] : [accepted[1]]) : accepted;
      mistakes.push({n:i+1, question: questionText, user:u, correct:langAnswer});
    }
  }

  document.getElementById('score').textContent = `${correctCount} / ${correct.length}`;
  
  let messageText;
  if(correctCount === correct.length) {
    messageText = translations[lang].wellDone;
  } else {
    const percentage = (correctCount / correct.length) * 100;
    const msg = translations[lang].messages.find(m => percentage >= m.min && percentage < m.max);
    messageText = msg ? msg.text : translations[lang].messages[0].text;
  }
  document.getElementById('message').textContent = messageText;

  if(mistakes.length){
    const el = document.getElementById('details');
    el.style.display = 'block';
    el.innerHTML = `<strong>${translations[lang].mistakes}</strong><br><br>` + mistakes.map(m=>{
      return `<div style="margin-bottom:.8rem;padding:.6rem;background:#fff;border-left:3px solid #e0a169;border-radius:4px"><p style="margin:0.4rem 0 0.3rem 0;font-style:italic;color:#666;font-size:0.9rem">${m.question||''}</p><br><p class="mistake-line"><strong>${translations[lang].yourAnswer}</strong> <em class="user">${m.user||'‚Äî'}</em></p><p class="mistake-line"><strong>${translations[lang].correctAnswer}</strong> <em class="correct">${m.correct.join(', ')}</em></p></div>`;
    }).join('');
  } else {
    document.getElementById('details').style.display = 'none';
  }
}

/* initial render */
render();

/* Prevent back button on results page */
history.pushState(null, null, window.location.href);
window.addEventListener('popstate', function() {
  history.pushState(null, null, window.location.href);
});
</script>