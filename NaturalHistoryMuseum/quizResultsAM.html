<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>Animal Museum â€” Results</title>
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <style>
        html,body{height:100%}
        body{margin:0;padding-top:env(safe-area-inset-top);padding-bottom:env(safe-area-inset-bottom);display:flex;align-items:center;justify-content:center;font-family:Segoe UI, Tahoma, Geneva, Verdana, sans-serif;background:linear-gradient(135deg,#e0f7fa 0%,#f1f8e9 100%)}
        .results-container{background:#fff;padding:2rem;border-radius:20px;box-shadow:0 12px 30px rgba(0,0,0,.12);max-width:520px;width:100%;position:relative;text-align:center}
        h2{color:#00796b;margin-top:0;margin-bottom:0.8rem}
        .score{font-size:1.3rem;color:#004d40;margin:.6rem 0;font-weight:600}
        .message{margin:1rem 0;color:#00695c;font-size:1.15rem;font-weight:600;line-height:1.5}
        .btn{padding:.7rem 1.4rem;border-radius:12px;border:none;background:linear-gradient(90deg,#26a69a,#80cbc4);color:#fff;cursor:pointer;font-weight:600;transition:all 0.2s ease}
        .btn:hover{transform:translateY(-2px);box-shadow:0 8px 16px rgba(38,166,154,0.3)}
        .details{margin-top:1rem;text-align:left;background:#e0f2f1;padding:1.2rem;border-radius:12px;max-height:380px;overflow-y:auto;display:none}
        .details strong{color:#d32f2f;font-size:1rem;display:block;margin-bottom:1rem}
        .mistake-item{margin-bottom:1rem;padding:0.9rem;background:#fff;border-left:4px solid #d32f2f;border-radius:6px;box-shadow:0 2px 8px rgba(0,0,0,0.05)}
        .mistake-item strong{color:#004d40;display:block;margin-bottom:0.5rem;font-size:0.95rem}
        .mistake-item p{margin:0.4rem 0;font-size:0.95rem;color:#004d40;line-height:1.4}
        .mistake-item p.user{color:#d32f2f}
        .mistake-item p.correct{color:#388e3c}
        @media(max-width:520px){
            .results-container{padding:1.2rem 0.9rem;border-radius:18px;margin:0.5rem;max-width:95vw}
            h2{font-size:1.1rem;margin-bottom:0.6rem}
            .score{font-size:1.8rem;margin:0.5rem 0}
            .message{font-size:0.95rem;margin:0.8rem 0;line-height:1.4}
            .details{padding:0.9rem;max-height:280px;font-size:0.9rem}
            .details strong{font-size:0.95rem}
            .mistake-item{padding:0.75rem;margin-bottom:0.8rem}
            .btn{padding:0.6rem 1.2rem;font-size:0.9rem;border-radius:10px;min-height:44px}
        }
    </style>
</head>
<body>
    <div class="results-container">

        <h2 id="results-title">Results</h2>
        <div class="score" id="score"></div>
        <div class="message" id="message"></div>

        <div class="details" id="details" style="display:none"></div>
    </div>

    <script>
        const translations = {
            en: {
                results: "Quiz Results",
                wellDone: "Perfect! You are a true naturalist! ðŸŽ‰",
                messages: [
                    { min: 0, max: 20, text: "Don't worry! Keep learning and you'll improve. ðŸ’ª" },
                    { min: 20, max: 40, text: "Good effort! ðŸ“š" },
                    { min: 40, max: 60, text: "Nice work! ðŸŒŸ" },
                    { min: 60, max: 80, text: "Very good! Almost there! ðŸš€" },
                    { min: 80, max: 100, text: "Excellent! You really know your stuff! ðŸ‘" }
                ],
                back: "Back to start",
                mistakes: "Your Mistakes:",
                yourAnswer: "Your answer:",
                correctAnswer: "Correct answer:",
                notAnswered: "Not answered"
            },
            bg: {
                results: "Ð ÐµÐ·ÑƒÐ»Ñ‚Ð°Ñ‚Ð¸ Ð¾Ñ‚ Ð²Ð¸ÐºÑ‚Ð¾Ñ€Ð¸Ð½Ð°Ñ‚Ð°",
                wellDone: "ÐŸÐµÑ€Ñ„ÐµÐºÑ‚Ð½Ð¾! Ð’Ð¸Ðµ ÑÑ‚Ðµ Ð¸ÑÑ‚Ð¸Ð½ÑÐºÐ¸ Ð½Ð°Ñ‚ÑƒÑ€Ð°Ð»Ð¸ÑÑ‚! ðŸŽ‰",
                messages: [
                    { min: 0, max: 20, text: "ÐÐµ ÑÐµ Ð¿Ñ€Ð¸Ñ‚ÐµÑÐ½ÑÐ²Ð°Ð¹Ñ‚Ðµ! ÐžÐ¿Ð¸Ñ‚Ð°Ð¹Ñ‚Ðµ Ð¾Ñ‚Ð½Ð¾Ð²Ð¾ ðŸ’ª" },
                    { min: 20, max: 40, text: "Ð”Ð¾Ð±ÑŠÑ€ Ð¾Ð¿Ð¸Ñ‚! ðŸ“š" },
                    { min: 40, max: 60, text: "Ð”Ð¾Ð±ÑŠÑ€ Ð¾Ð¿Ð¸Ñ‚! ðŸŒŸ" },
                    { min: 60, max: 80, text: "ÐœÐ½Ð¾Ð³Ð¾ Ð´Ð¾Ð±Ñ€Ðµ!ðŸš€" },
                    { min: 80, max: 100, text: "ÐžÑ‚Ð»Ð¸Ñ‡Ð½Ð¾! ÐÐ°Ð¸ÑÑ‚Ð¸Ð½Ð° Ð·Ð½Ð°ÐµÑ‚Ðµ Ð¼Ð°Ñ‚ÐµÑ€Ð¸Ð°Ð»Ð°! ðŸ‘" }
                ],
                back: "ÐÐ°Ð·Ð°Ð´ ÐºÑŠÐ¼ Ð½Ð°Ñ‡Ð°Ð»Ð¾Ñ‚Ð¾",
                mistakes: "Ð’Ð°ÑˆÐ¸Ñ‚Ðµ Ð³Ñ€ÐµÑˆÐºÐ¸:",
                yourAnswer: "Ð’Ð°ÑˆÐ¸ÑÑ‚ Ð¾Ñ‚Ð³Ð¾Ð²Ð¾Ñ€:",
                correctAnswer: "ÐŸÑ€Ð°Ð²Ð¸Ð»ÐµÐ½ Ð¾Ñ‚Ð³Ð¾Ð²Ð¾Ñ€:",
                notAnswered: "ÐÑÐ¼Ð° Ð¾Ñ‚Ð³Ð¾Ð²Ð¾Ñ€"
            }
        };
        let lang = localStorage.getItem('language') || 'en';

        function normalize(s){ return (s||"").toString().trim().toLowerCase(); }

        function normalizeArray(arr){
            return (arr || []).map(normalize).filter(Boolean).sort();
        }

        function answersMatch(correctValues, userValue){
            const correctArray = Array.isArray(correctValues) ? correctValues : [correctValues];
            if(Array.isArray(userValue)){
                const left = normalizeArray(correctArray);
                const right = normalizeArray(userValue);
                if(left.length !== right.length) return false;
                return left.every((val, idx) => val === right[idx]);
            }
            return correctArray.some(val => normalize(val) === normalize(userValue));
        }

        function render(){
            document.getElementById('results-title').textContent = translations[lang].results;

            const correctAnswers = JSON.parse(localStorage.getItem('correctAnswersAM') || '[]');
            const userAnswers = JSON.parse(localStorage.getItem('userAnswersAM') || '[]');
            const questionsData = JSON.parse(localStorage.getItem('questionsAM') || '[]');
            let correctCount = 0;
            const mistakes = [];

            for(let i=0;i<correctAnswers.length;i++){
                const correctItem = correctAnswers[i] || [];
                const user = userAnswers[i] || "";
                const qObj = questionsData[i] || {};
                
                // Get the correct answers for current language
                let accepted = [];
                if (typeof correctItem === 'object' && !Array.isArray(correctItem)) {
                    accepted = correctItem[lang] || correctItem.en || [];
                } else {
                    accepted = correctItem;
                }
                
                const matched = answersMatch(accepted, user);
                if(matched) {
                    correctCount++;
                } else {
                    // Get question text - check for both formats: text.en/text.bg and question/questionBg
                    let questionText = '';
                    if (qObj.text && typeof qObj.text === 'object') {
                        questionText = lang === 'en' ? (qObj.text.en || '') : (qObj.text.bg || '');
                    } else {
                        questionText = lang === 'en' ? (qObj.question || '') : (qObj.questionBg || '');
                    }
                    // Filter correct answers to show only current language
                    let langAnswer = [];
                    if (typeof correctItem === 'object' && !Array.isArray(correctItem)) {
                        langAnswer = Array.isArray(accepted) ? accepted : [accepted];
                    } else {
                        langAnswer = lang === 'en' ? [correctItem[0]] : [correctItem[1]];
                    }
                    mistakes.push({num:i+1, question: questionText, user, correct:langAnswer});
                }
            }

            document.getElementById('score').textContent = correctCount + " / " + correctAnswers.length;
            
            let messageText;
            if(correctCount === correctAnswers.length) {
                messageText = translations[lang].wellDone;
            } else {
                const percentage = (correctCount / correctAnswers.length) * 100;
                const msg = translations[lang].messages.find(m => percentage >= m.min && percentage < m.max);
                messageText = msg ? msg.text : translations[lang].messages[0].text;
            }
            document.getElementById('message').textContent = messageText;

            if(mistakes.length){
                const el = document.getElementById('details');
                el.style.display = 'block';
                el.innerHTML = '<strong>' + translations[lang].mistakes + '</strong>' + mistakes.map(m=>{
                    const userText = Array.isArray(m.user) ? m.user.join(', ') : (m.user||translations[lang].notAnswered);
                    return '<div class="mistake-item"><p style="margin:0.6rem 0 0.3rem 0;font-style:italic;color:#666">' + (m.question||'') + '</p><p class="user"><strong>' + translations[lang].yourAnswer + '</strong> <em style="color:#d32f2f;font-weight:600;">' + userText + '</em></p><p class="correct"><strong>' + translations[lang].correctAnswer + '</strong> <em style="color:#388e3c;font-weight:600;">' + m.correct.join(', ') + '</em></p></div>';
                }).join('');
            } else {
                document.getElementById('details').style.display = 'none';
            }
        }

        // initial render
        render();

        // Prevent back button on results page
        history.pushState(null, null, window.location.href);
        window.addEventListener('popstate', function() {
            history.pushState(null, null, window.location.href);
        });
    </script>
</body>
</html>